{% extends "admin/base.html" %}
{% block title %}ç½‘é¡µç»ˆç«¯{% endblock %}

{% block content %}
<div class="admin-header">
  <h1>ğŸ’» ç½‘é¡µç»ˆç«¯</h1>
  <span style="color:#aaa; font-size:0.85rem;">å‘½ä»¤åœ¨åšå®¢æ ¹ç›®å½•ä¸‹æ‰§è¡Œï¼Œè¶…æ—¶é™åˆ¶ 15 ç§’</span>
</div>

<div class="terminal-wrap">
  <div class="terminal-output" id="output">
    <div class="term-line term-info">æ¬¢è¿ä½¿ç”¨ç½‘é¡µç»ˆç«¯ï¼Œè¾“å…¥å‘½ä»¤åæŒ‰ Enter æ‰§è¡Œã€‚</div>
  </div>
  <div class="terminal-input-row">
    <span class="term-prompt">$</span>
    <input type="text" id="cmd-input" class="term-input" placeholder="è¾“å…¥å‘½ä»¤â€¦" autocomplete="off" autofocus />
    <button class="btn btn-primary" id="run-btn">æ‰§è¡Œ</button>
  </div>
</div>

<script>
const input = document.getElementById("cmd-input");
const output = document.getElementById("output");
const runBtn = document.getElementById("run-btn");
const history = [];
let histIdx = -1;

async function runCmd() {
  const cmd = input.value.trim();
  if (!cmd) return;

  history.unshift(cmd);
  histIdx = -1;

  appendLine(`$ ${cmd}`, "term-cmd");
  input.value = "";
  runBtn.disabled = true;

  try {
    const res = await fetch("/admin/terminal/exec", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ cmd }),
    });
    const data = await res.json();
    appendLine(data.output, "term-output");
  } catch (e) {
    appendLine("ç½‘ç»œé”™è¯¯ï¼š" + e.message, "term-error");
  }

  runBtn.disabled = false;
  input.focus();
}

function appendLine(text, cls) {
  const div = document.createElement("div");
  div.className = "term-line " + cls;
  div.textContent = text;
  output.appendChild(div);
  output.scrollTop = output.scrollHeight;
}

runBtn.addEventListener("click", runCmd);
input.addEventListener("keydown", (e) => {
  if (e.key === "Enter") { runCmd(); return; }
  if (e.key === "ArrowUp") {
    histIdx = Math.min(histIdx + 1, history.length - 1);
    input.value = history[histIdx] || "";
  }
  if (e.key === "ArrowDown") {
    histIdx = Math.max(histIdx - 1, -1);
    input.value = histIdx >= 0 ? history[histIdx] : "";
  }
});
</script>
{% endblock %}
